<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gus 3D Pro: Bosque v12.2 üå≥</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --naranja: #d84315; --verde: #558b2f; --glass: rgba(255, 255, 255, 0.15); }

        body { 
            font-family: 'Quicksand', sans-serif; margin: 0; min-height: 100vh;
            background: url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=1920') no-repeat center fixed;
            background-size: cover; overflow-x: hidden;
        }

        /* --- GUS SOFT 3D REAL --- */
        #gus-container { position: fixed; z-index: 9999; cursor: pointer; transition: all 2s ease; left: 80%; top: 70%; }
        .gus-body {
            width: 100px; height: 100px;
            background: #e67e22; border-radius: 50% 50% 40% 40%;
            position: relative; box-shadow: inset -10px -10px 20px rgba(0,0,0,0.3), 0 20px 30px rgba(0,0,0,0.4);
            animation: breathe 3s infinite ease-in-out;
        }
        .gus-eye { position: absolute; background: #2c3e50; width: 12px; height: 12px; border-radius: 50%; top: 35%; border: 2px solid white; }
        .eye-l { left: 25%; } .eye-r { right: 25%; }
        .gus-tail { 
            position: absolute; right: -40px; top: 10px; width: 50px; height: 60px; 
            background: #d35400; border-radius: 50% 50% 0 50%; transform: rotate(20deg);
            box-shadow: inset -5px -5px 15px rgba(0,0,0,0.2);
        }
        @keyframes breathe { 0%, 100% { transform: scale(1) translateY(0); } 50% { transform: scale(1.05) translateY(-10px); } }

        #gus-bubble { 
            position: absolute; bottom: 120px; right: -50px; width: 220px; padding: 15px; 
            background: white; border-radius: 20px; display: none; font-weight: bold; font-size: 13px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); border-left: 5px solid var(--naranja);
        }

        /* --- UI GLASSMORPHISM --- */
        .glass { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 30px; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .card { padding: 20px; text-align: center; color: white; position: relative; }
        
        .progress-bar { width: 100%; height: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: #4caf50; width: 0%; transition: 1.5s; }

        .btn-menu { position: fixed; top: 20px; left: 20px; z-index: 1000; background: rgba(0,0,0,0.6); border: none; color: white; padding: 12px; border-radius: 50%; cursor: pointer; font-size: 20px; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10001; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 550px; border-radius: 30px; padding: 30px; max-height: 85vh; overflow-y: auto; }
        
        .audit-btn { background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 10px; cursor: pointer; font-size: 11px; margin-top: 5px; }
    </style>
</head>
<body>

<button class="btn-menu" onclick="abrirMenuPrincipal()">‚ãÆ</button>

<div id="gus-container" onclick="hablarGus('¬°Hola Jose! ¬øAnalizamos las bellotas?', 4000)">
    <div id="gus-bubble"></div>
    <div class="gus-body">
        <div class="gus-eye eye-l"></div>
        <div class="gus-eye eye-r"></div>
        <div class="gus-tail"></div>
    </div>
</div>

<div class="container" id="main">
    <header class="glass" style="padding: 30px; margin-bottom: 25px; text-align: center; color: white;">
        <button onclick="abrirMeta()" style="float: right; background: white; color: black; border: none; padding: 5px 15px; border-radius: 10px; font-weight: bold; cursor: pointer;">üéØ Meta</button>
        <div style="font-size: 0.9rem; opacity: 0.8;">BALANCE TOTAL</div>
        <div style="font-size: 3.5rem; font-weight: 800; margin: 10px 0;" id="total-val">Q0.00</div>
        <div class="progress-bar"><div class="progress-fill" id="fill"></div></div>
        <small id="perc-txt">0% de tu ahorro alcanzado</small>
    </header>
    <div class="grid" id="grid"></div>
</div>

<div id="modal-master" class="modal" onclick="cerrarModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="modal-titulo" style="color: var(--naranja)">Opciones</h2>
        <div id="modal-body"></div>
        <button onclick="cerrarModal()" style="width:100%; margin-top:20px; padding:12px; border-radius:15px; background:#eee; border:none; font-weight:bold; cursor:pointer">Cerrar</button>
    </div>
</div>

<script>
    const GIST_ID = 'dcb2ffeb425b761c097e6f435d434a35';
    let TOKEN = localStorage.getItem('mi_finanza_token') || prompt("Token de GitHub:");
    if(TOKEN) localStorage.setItem('mi_finanza_token', TOKEN);

    const REGLA = {
        "Necesidades": { p: 0.50, img: "https://images.unsplash.com/photo-1513836279014-a89f7a76ae86?w=200" },
        "Comida": { p: 0.10, img: "https://images.unsplash.com/photo-1505935428862-770b6f24f629?w=200" },
        "Transporte": { p: 0.10, img: "https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?w=200" },
        "Ahorro": { p: 0.15, img: "https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?w=200" },
        "Inversi√≥n": { p: 0.15, img: "https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=200" }
    };

    let itemsGlobal = [];

    async function cargar() {
        const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, { headers: { 'Authorization': `token ${TOKEN}` } });
        const data = await res.json();
        itemsGlobal = JSON.parse(data.files['finanzas.json'].content);
        
        let total = 0, ahorro = 0;
        const grid = document.getElementById('grid');
        grid.innerHTML = '';

        itemsGlobal.forEach((i, idx) => {
            total += i.monto;
            if(i.nombre === "Ahorro") ahorro = i.monto;
            grid.innerHTML += `
                <div class="card glass">
                    <div onclick="verHistorial('${i.nombre}')" style="position:absolute; top:10px; right:10px; cursor:pointer">üìñ</div>
                    <img src="${REGLA[i.nombre].img}" style="width:70px; height:70px; border-radius:50%; object-fit:cover; margin-bottom:10px; border:2px solid white">
                    <h3 style="margin:0">${i.nombre}</h3>
                    <div style="font-size:1.8rem; font-weight:800; color:#ffeb3b">Q${i.monto.toFixed(2)}</div>
                    <div style="margin-top:10px">
                        <input type="number" id="in-${i.nombre}" placeholder="Q" style="width:60px; border-radius:5px; border:none; padding:5px">
                        <button onclick="modificar('${i.nombre}', 1)" style="background:var(--verde); color:white; border:none; border-radius:5px; padding:5px 10px; cursor:pointer">+</button>
                        <button onclick="modificar('${i.nombre}', -1)" style="background:#c62828; color:white; border:none; border-radius:5px; padding:5px 10px; cursor:pointer">-</button>
                    </div>
                    <button class="audit-btn" onclick="abrirAuditoria('${i.nombre}', ${i.monto})">üîç ¬øNo cuadra f√≠sico?</button>
                </div>`;
        });
        document.getElementById('total-val').innerText = `Q${total.toFixed(2)}`;
        actualizarMeta(ahorro);
    }

    // --- AUDITOR√çA F√çSICA ---
    function abrirAuditoria(nombre, montoDigital) {
        document.getElementById('modal-titulo').innerText = "Ajuste de Caja: " + nombre;
        document.getElementById('modal-body').innerHTML = `
            <p>Gus dice: "Jose, cu√©ntame cu√°nto tienes f√≠sicamente ahora mismo."</p>
            <input type="number" id="montoFisico" placeholder="Cantidad real Q" style="width:100%; padding:15px; border-radius:10px; border:1px solid #ddd; font-size:1.2rem">
            <button onclick="procesarAjuste('${nombre}', ${montoDigital})" style="width:100%; margin-top:15px; background:var(--naranja); color:white; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer">Analizar y Ajustar</button>
        `;
        document.getElementById('modal-master').style.display = 'flex';
    }

    async function procesarAjuste(nombre, digital) {
        const fisico = parseFloat(document.getElementById('montoFisico').value);
        if(isNaN(fisico)) return;
        const dif = fisico - digital;
        itemsGlobal = itemsGlobal.map(i => i.nombre === nombre ? {...i, monto: fisico} : i);
        registrarHistorial(nombre, Math.abs(dif), dif > 0 ? 'add' : 'sub', "Ajuste por descuadre f√≠sico");
        await enviar(itemsGlobal);
        hablarGus(`Ajuste completado. ${dif > 0 ? 'Encontramos' : 'Gastaste'} Q${Math.abs(dif).toFixed(2)} que no anotamos.`, 6000);
        cerrarModal();
    }

    // --- ASESOR BANCARIO CON GUS ---
    function abrirMenuPrincipal() {
        document.getElementById('modal-titulo').innerText = "Men√∫ Principal";
        document.getElementById('modal-body').innerHTML = `
            <button class="btn-menu-opt" onclick="abrirMeta()">üéØ Ajustar Meta</button>
            <button class="btn-menu-opt" onclick="abrirAsesorBancario()">üè¶ Consultar Bancos (Asesor Gus)</button>
            <button class="btn-menu-opt" onclick="reiniciarTodo()" style="color:red">üîÑ Reset Bosque</button>
        `;
        document.getElementById('modal-master').style.display = 'flex';
    }

    function abrirAsesorBancario() {
        document.getElementById('modal-titulo').innerText = "Asesor Bancario Gus";
        document.getElementById('modal-body').innerHTML = `
            <input type="text" id="busquedaBanco" placeholder="Ej: Tarjeta de d√©bito" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd">
            <button onclick="consultarBanco()" style="width:100%; margin-top:10px; background:var(--verde); color:white; border:none; padding:10px; border-radius:10px; cursor:pointer">Consultar Ofertas</button>
            <div id="resultadoBanco" style="margin-top:20px; font-size:14px; color:#333"></div>
        `;
    }

    function consultarBanco() {
        const q = document.getElementById('busquedaBanco').value.toLowerCase();
        let res = "";
        if(q.includes("tarjeta")) {
            res = `<b>Banrural:</b> Cuenta Goleadora y Tarjeta de D√©bito Visa. <br><b>Banco Industrial:</b> Bi Cheque con beneficios en puntos Bi.<br><br>
                   <div style="background:#fff3e0; padding:10px; border-left:4px solid orange">üêøÔ∏è <b>Gus aconseja:</b> Jose, si buscas ahorro, Banrural suele tener menos cobros por manejo, pero BI tiene mejores descuentos en comercios. ¬°Elige BI si compras mucho fuera!</div>`;
        } else {
            res = "Gus no encontr√≥ ofertas espec√≠ficas para eso, pero sugiere revisar las Cuentas de Ahorro de BI para tu meta actual.";
        }
        document.getElementById('resultadoBanco').innerHTML = res;
    }

    // --- HISTORIAL ---
    function verHistorial(nombre) {
        const hist = JSON.parse(localStorage.getItem('hist_v12')) || [];
        const filtrado = hist.filter(h => h.cuenta === nombre);
        document.getElementById('modal-titulo').innerText = "Historial: " + nombre;
        document.getElementById('modal-body').innerHTML = filtrado.length ? filtrado.map(h => `<div style="border-bottom:1px solid #eee; padding:10px">
            <small>${h.fecha}</small><br><b>${h.tipo === 'add' ? '+' : '-'} Q${h.monto}</b> - ${h.nota || 'Movimiento manual'}
        </div>`).join('') : "No hay registros a√∫n.";
        document.getElementById('modal-master').style.display = 'flex';
    }

    function registrarHistorial(cuenta, monto, tipo, nota = "") {
        let hist = JSON.parse(localStorage.getItem('hist_v12')) || [];
        hist.unshift({ cuenta, monto, tipo, nota, fecha: new Date().toLocaleString() });
        localStorage.setItem('hist_v12', JSON.stringify(hist.slice(0, 50)));
    }

    // --- CORE ---
    async function modificar(nombre, signo) {
        const val = parseFloat(document.getElementById(`in-${nombre}`).value);
        if(!val) return;
        itemsGlobal = itemsGlobal.map(i => i.nombre === nombre ? {...i, monto: i.monto + (val * signo)} : i);
        registrarHistorial(nombre, val, signo > 0 ? 'add' : 'sub');
        await enviar(itemsGlobal);
    }

    async function enviar(datos) {
        await fetch(`https://api.github.com/gists/${GIST_ID}`, {
            method: 'PATCH',
            headers: { 'Authorization': `token ${TOKEN}` },
            body: JSON.stringify({ files: { "finanzas.json": { content: JSON.stringify(datos, null, 2) } } })
        });
        cargar();
    }

    function actualizarMeta(ahorro) {
        let m = parseFloat(localStorage.getItem('meta_v12')) || 1000;
        let p = Math.min((ahorro / m) * 100, 100);
        document.getElementById('fill').style.width = p + "%";
        document.getElementById('perc-txt').innerText = `${p.toFixed(1)}% de Q${m}`;
    }

    function hablarGus(t, d) {
        const b = document.getElementById('gus-bubble');
        b.innerText = t; b.style.display = 'block';
        setTimeout(() => b.style.display = 'none', d);
    }

    function cerrarModal() { document.getElementById('modal-master').style.display = 'none'; }
    function abrirMeta() { /* igual que antes */ }
    window.onload = cargar;
</script>

<style>
    .btn-menu-opt { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 15px; border: 1px solid #ddd; background: white; cursor: pointer; font-weight: bold; text-align: left; }
</style>
</body>
</html>
