<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repartidor Inteligente</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #10b981; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; display: flex; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 400px; }
        .card { background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border: 1px solid #334155; }
        .total-box { text-align: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #334155; }
        .total-amount { font-size: 3rem; font-weight: 800; color: var(--accent); }
        
        .input-group { background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        input { width: 100%; background: transparent; border: none; color: white; font-size: 1.2rem; outline: none; text-align: center; }
        button { width: 100%; background: var(--accent); border: none; padding: 12px; border-radius: 8px; color: #0f172a; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #059669; }

        .cat-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #334155; }
        .cat-name { font-size: 0.9rem; color: #94a3b8; }
        .cat-val { font-weight: bold; color: #38bdf8; }
        .perc-tag { font-size: 0.7rem; background: #334155; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="total-box">
                <small>BALANCE TOTAL</small>
                <div id="total-general" class="total-amount">Q0.00</div>
            </div>

            <div class="input-group">
                <small style="color: #94a3b8; display: block; margin-bottom: 5px;">REPARTIR NUEVO INGRESO / BONO</small>
                <input type="number" id="nuevo-monto" placeholder="Q0.00">
                <button onclick="repartirMonto()" style="margin-top: 10px;">REPARTIR PORCENTAJES</button>
            </div>

            <div id="lista-categorias">
                </div>
            
            <p id="status" style="font-size: 0.7rem; text-align: center; margin-top: 15px; color: #4b5563;">Conectado a Gist</p>
        </div>
    </div>

    <script>
        const GIST_ID = 'dcb2ffeb425b761c097e6f435d434a35';
        const TOKEN = prompt("Introduce tu Token:");
        
        // AQUÍ DEFINES TUS PORCENTAJES (Asegúrate que sumen 100)
        const REGLA = {
            "Necesidades": 0.50, // 50%
            "Comida": 0.20,      // 20%
            "Ahorro": 0.15,      // 15%
            "Inversión": 0.10,   // 10%
            "Transporte": 0.05   // 5%
        };

        async function cargar() {
            const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                headers: { 'Authorization': `token ${TOKEN}` }
            });
            const data = await res.json();
            const items = JSON.parse(data.files['finanzas.json'].content);
            
            let total = 0;
            const lista = document.getElementById('lista-categorias');
            lista.innerHTML = '';

            items.forEach(i => {
                total += i.monto;
                const pct = (REGLA[i.nombre] * 100) || 0;
                lista.innerHTML += `
                    <div class="cat-item">
                        <span class="cat-name">${i.nombre} <span class="perc-tag">${pct}%</span></span>
                        <span class="cat-val">Q${i.monto.toFixed(2)}</span>
                    </div>`;
            });
            document.getElementById('total-general').innerText = `Q${total.toFixed(2)}`;
        }

        async function repartirMonto() {
            const montoIngresado = parseFloat(document.getElementById('nuevo-monto').value);
            if (!montoIngresado || montoIngresado <= 0) return alert("Ingresa un monto válido");

            document.getElementById('status').innerText = "Repartiendo...";

            // 1. Obtener datos actuales
            const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                headers: { 'Authorization': `token ${TOKEN}` }
            });
            const data = await res.json();
            let items = JSON.parse(data.files['finanzas.json'].content);

            // 2. Sumar el porcentaje a cada categoría
            items = items.map(item => {
                const porcentaje = REGLA[item.nombre] || 0;
                return {
                    nombre: item.nombre,
                    monto: item.monto + (montoIngresado * porcentaje)
                };
            });

            // 3. Guardar en GitHub
            await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                method: 'PATCH',
                headers: { 'Authorization': `token ${TOKEN}` },
                body: JSON.stringify({
                    files: { "finanzas.json": { content: JSON.stringify(items, null, 2) } }
                })
            });

            document.getElementById('nuevo-monto').value = '';
            document.getElementById('status').innerText = "✅ ¡Repartido con éxito!";
            cargar();
        }

        cargar();
    </script>
</body>
</html>
